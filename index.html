<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å•è¯å¡ç‰‡ Pro Max</title>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f1f5f9;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-sub: #64748b;
            --red: #ef4444;
            --green: #22c55e;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            color: var(--text-main);
        }

        /* é€šç”¨æŒ‰é’®æ ·å¼ */
        button { border: none; outline: none; cursor: pointer; font-family: inherit; }

        /* ----------------
           è§†å›¾åˆ‡æ¢é€»è¾‘ 
           ---------------- */
        .view {
            display: none;
            flex: 1;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }
        .view.active { display: flex; }

        /* ----------------
           é¦–é¡µï¼šæ–‡ä»¶å¤¹åˆ—è¡¨
           ---------------- */
        .home-header {
            padding: 20px;
            background: #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .home-title { font-size: 1.4rem; font-weight: 800; }
        
        .folder-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .folder-card {
            background: #fff;
            padding: 20px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.1s;
        }
        .folder-card:active { transform: scale(0.98); }

        .folder-info h3 { font-size: 1.1rem; margin-bottom: 4px; }
        .folder-info p { font-size: 0.85rem; color: var(--text-sub); }
        .folder-arrow { color: #cbd5e1; font-size: 1.2rem; }

        .fab {
            position: absolute;
            bottom: 30px;
            right: 30px;
            width: 56px;
            height: 56px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            font-size: 2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.4);
            z-index: 10;
        }

        /* ----------------
           å­¦ä¹ é¡µï¼šå¡ç‰‡æ¨¡å¼
           ---------------- */
        .study-header {
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg);
        }
        .back-btn { font-size: 1rem; color: var(--text-main); background: none; display: flex; align-items: center; gap: 5px; font-weight: 600; }
        .folder-name-badge { font-size: 0.9rem; font-weight: 600; color: var(--text-sub); }

        .card-area {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            perspective: 1000px;
        }

        .card-container {
            width: 100%;
            max-width: 340px;
            height: 480px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s cubic-bezier(0.4, 0.2, 0.2, 1);
        }
        .card-container.is-flipped { transform: rotateY(180deg); }

        .card-face {
            position: absolute;
            width: 100%; height: 100%;
            backface-visibility: hidden;
            border-radius: 24px;
            background: var(--card-bg);
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 30px;
            text-align: center;
        }
        
        /* æ­£é¢ */
        .card-front { z-index: 2; }
        /* èƒŒé¢ */
        .card-back { transform: rotateY(180deg); justify-content: space-between; padding: 40px 30px; }

        .word { font-size: 2.2rem; font-weight: 800; margin-bottom: 20px; color: var(--text-main); word-break: break-word; line-height: 1.1; }
        .definition { font-size: 1.3rem; font-weight: 600; color: var(--text-main); margin-top: 10px; }
        .sentence-box { background: #f8fafc; padding: 16px; border-radius: 12px; width: 100%; text-align: left; font-style: italic; color: #475569; font-size: 0.95rem; }
        
        .phonetic-btn {
            background: #eff6ff; color: var(--primary); padding: 8px 16px; border-radius: 20px;
            font-size: 0.9rem; font-weight: 600; display: flex; align-items: center; gap: 6px; margin-top: 10px;
        }

        .controls { padding: 20px 30px 40px; display: flex; gap: 20px; width: 100%; max-width: 400px; margin: 0 auto; }
        .ctrl-btn {
            flex: 1; padding: 16px; border-radius: 16px; font-size: 1rem; font-weight: 700; color: white;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); transition: transform 0.1s;
        }
        .ctrl-btn:active { transform: scale(0.96); }
        .btn-fail { background: white; color: var(--red); border: 2px solid #fecaca; }
        .btn-pass { background: var(--green); }

        /* ----------------
           é€šç”¨å¼¹çª—
           ---------------- */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: flex-end;
        }
        .modal.open { display: flex; }
        .modal-content {
            background: white; width: 100%; max-width: 600px; border-radius: 20px 20px 0 0;
            padding: 24px; animation: slideUp 0.3s ease; max-height: 90vh; overflow-y: auto;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 1.2rem; font-weight: 700; }
        
        textarea, input[type="text"] {
            width: 100%; border: 1px solid #cbd5e1; border-radius: 12px; padding: 14px;
            font-size: 1rem; margin-bottom: 16px; font-family: inherit;
        }
        textarea { height: 120px; font-family: monospace; resize: none; }

        .btn-block { width: 100%; padding: 14px; border-radius: 12px; font-weight: 600; margin-bottom: 10px; font-size: 1rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: transparent; border: 1px solid #cbd5e1; color: var(--text-sub); }
        
        .empty-state { text-align: center; color: #94a3b8; margin-top: 100px; display: flex; flex-direction: column; align-items: center; gap: 10px; }

    </style>
</head>
<body>

<div id="view-home" class="view active">
    <header class="home-header">
        <div class="home-title">æˆ‘çš„ç”Ÿè¯æœ¬</div>
        <button onclick="openGlobalSettings()" style="font-size:1.5rem; background:none;">âš™ï¸</button>
    </header>
    
    <div class="folder-list" id="folderList">
        </div>

    <button class="fab" onclick="openCreateFolder()">+</button>
</div>

<div id="view-study" class="view">
    <header class="study-header">
        <button class="back-btn" onclick="goHome()">
            <span style="font-size:1.2rem">â€¹</span> è¿”å›åˆ—è¡¨
        </button>
        <div class="folder-name-badge" id="currentFolderName">é»˜è®¤æ–‡ä»¶å¤¹</div>
        <button onclick="openImportModal()" style="font-size:1.2rem; background:none; padding:5px;">â• å¯¼å…¥</button>
    </header>

    <div class="card-area">
        <div class="card-container" id="flashcard" onclick="flipCard()">
            <div class="card-face card-front">
                <div class="word" id="front-word">Ready?</div>
                <button class="phonetic-btn" onclick="playAudio(event)">ğŸ”Š å‘éŸ³</button>
                <div style="font-size:0.8rem; color:#94a3b8; margin-top:auto">ç‚¹å‡»ç¿»é¢</div>
            </div>
            <div class="card-face card-back">
                <div style="width:100%">
                    <div class="word" id="back-word" style="font-size:1.6rem"></div>
                    <div class="definition" id="back-def"></div>
                </div>
                <div class="sentence-box"><div id="back-sentence"></div></div>
                <button class="phonetic-btn" onclick="playAudio(event)">ğŸ”Š</button>
            </div>
        </div>
    </div>

    <div class="controls">
        <button class="ctrl-btn btn-fail" onclick="nextCard(false)">âœ• å¿˜è¯</button>
        <button class="ctrl-btn btn-pass" onclick="nextCard(true)">âœ“ è®°ä½äº†</button>
    </div>
</div>

<div class="modal" id="modalCreateFolder" onclick="if(event.target===this) closeModal('modalCreateFolder')">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">æ–°å»ºæ–‡ä»¶å¤¹</div>
            <button onclick="closeModal('modalCreateFolder')" style="font-size:1.5rem;background:none">Ã—</button>
        </div>
        <input type="text" id="newFolderName" placeholder="ä¾‹å¦‚ï¼šç»æµå­¦äºº / 2024-05 ç”Ÿè¯">
        <button class="btn-block btn-primary" onclick="createFolder()">åˆ›å»º</button>
    </div>
</div>

<div class="modal" id="modalImport" onclick="if(event.target===this) closeModal('modalImport')">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">å¯¼å…¥å•è¯</div>
            <button onclick="closeModal('modalImport')" style="font-size:1.5rem;background:none">Ã—</button>
        </div>
        <p style="font-size:0.9rem; color:#64748b; margin-bottom:10px">å°†å•è¯æ·»åŠ åˆ°ï¼š<strong id="importTargetName"></strong></p>
        <textarea id="jsonInput" placeholder='ç²˜è´´ JSON æ ¼å¼ï¼š[{"word":"Hi","definition":"ä½ å¥½","sentence":"..."}]'></textarea>
        <button class="btn-block btn-primary" onclick="importWords()">ç¡®è®¤å¯¼å…¥</button>
    </div>
</div>

<div class="modal" id="modalSettings" onclick="if(event.target===this) closeModal('modalSettings')">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">è®¾ç½®ä¸å¤‡ä»½</div>
            <button onclick="closeModal('modalSettings')" style="font-size:1.5rem;background:none">Ã—</button>
        </div>
        
        <div style="margin-bottom:20px;">
            <p style="font-weight:600; margin-bottom:10px">æ•°æ®å¤‡ä»½</p>
            <button class="btn-block btn-primary" onclick="exportData()">â¬‡ï¸ å¯¼å‡ºæ‰€æœ‰æ•°æ® (JSONæ–‡ä»¶)</button>
            <p style="font-size:0.8rem; color:#64748b; margin-top:5px">å¯¼å‡ºåå¯å°†æ–‡ä»¶ä¿å­˜åœ¨æ‰‹æœºæˆ–ç”µè„‘ä¸­ï¼Œé˜²æ­¢ä¸¢å¤±ã€‚</p>
        </div>

        <div style="margin-top:20px; border-top:1px solid #eee; padding-top:20px;">
             <p style="font-weight:600; margin-bottom:10px">å±é™©åŒºåŸŸ</p>
             <button class="btn-block btn-outline" style="color:var(--red); border-color:var(--red)" onclick="clearAllData()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
        </div>
    </div>
</div>

<script>
    // --- æ•°æ®ç»“æ„å®šä¹‰ ---
    // AppData = Array<Folder>
    // Folder = { id: string, name: string, words: Array<Word> }
    // Word = { word: string, definition: string, sentence: string }
    
    let appData = [];
    let currentFolderId = null;
    let studyQueue = [];
    let currentCardIndex = 0;
    let isFlipped = false;

    // --- åˆå§‹åŒ– & è¿ç§» ---
    window.onload = function() {
        const raw = localStorage.getItem('myWords');
        
        if (raw) {
            try {
                const parsed = JSON.parse(raw);
                // æ£€æŸ¥æ˜¯å¦æ˜¯æ—§ç‰ˆæ•°æ® (æ—§ç‰ˆæ˜¯çº¯å•è¯æ•°ç»„ï¼Œæ–°ç‰ˆæ˜¯æ–‡ä»¶å¤¹æ•°ç»„)
                if (Array.isArray(parsed) && parsed.length > 0 && parsed[0].hasOwnProperty('word') && !parsed[0].hasOwnProperty('words')) {
                    // âš ï¸ æ‰§è¡Œè¿ç§»
                    console.log("æ£€æµ‹åˆ°æ—§ç‰ˆæ•°æ®ï¼Œæ­£åœ¨è¿ç§»...");
                    appData = [{
                        id: 'default-' + Date.now(),
                        name: 'é»˜è®¤ç”Ÿè¯æœ¬ (å·²è¿ç§»)',
                        words: parsed
                    }];
                    saveToLocal();
                } else if (Array.isArray(parsed)) {
                    // æ–°ç‰ˆç»“æ„
                    appData = parsed;
                } else {
                    initEmpty();
                }
            } catch (e) {
                console.error(e);
                initEmpty();
            }
        } else {
            initEmpty();
        }

        renderHome();
        window.speechSynthesis.getVoices(); // é¢„åŠ è½½å£°éŸ³
    };

    function initEmpty() {
        appData = [{ id: 'folder-1', name: 'æˆ‘çš„ç”Ÿè¯æœ¬', words: [] }];
        saveToLocal();
    }

    function saveToLocal() {
        localStorage.setItem('myWords', JSON.stringify(appData));
        renderHome();
    }

    // --- é¦–é¡µé€»è¾‘ ---
    function renderHome() {
        const list = document.getElementById('folderList');
        list.innerHTML = '';

        if (appData.length === 0) {
            list.innerHTML = `<div class="empty-state">è¿˜æ²¡æœ‰æ–‡ä»¶å¤¹ï¼Œç‚¹å‡»å³ä¸‹è§’ + åˆ›å»º</div>`;
            return;
        }

        appData.forEach(folder => {
            const div = document.createElement('div');
            div.className = 'folder-card';
            div.onclick = () => openFolder(folder.id);
            div.innerHTML = `
                <div class="folder-info">
                    <h3>ğŸ“ ${folder.name}</h3>
                    <p>${folder.words.length} ä¸ªå•è¯</p>
                </div>
                <div class="folder-arrow">â€º</div>
            `;
            list.appendChild(div);
        });
    }

    function openCreateFolder() {
        document.getElementById('modalCreateFolder').classList.add('open');
        document.getElementById('newFolderName').value = '';
        document.getElementById('newFolderName').focus();
    }

    function createFolder() {
        const name = document.getElementById('newFolderName').value.trim();
        if (!name) return;
        
        const newFolder = {
            id: 'folder-' + Date.now(),
            name: name,
            words: []
        };
        appData.unshift(newFolder); // æ–°å»ºçš„æ”¾æœ€å‰
        saveToLocal();
        closeModal('modalCreateFolder');
    }

    // --- å­¦ä¹ æ¨¡å¼é€»è¾‘ ---
    function openFolder(id) {
        currentFolderId = id;
        const folder = appData.find(f => f.id === id);
        if(!folder) return;

        // åˆ‡æ¢è§†å›¾
        document.getElementById('view-home').classList.remove('active');
        document.getElementById('view-study').classList.add('active');

        document.getElementById('currentFolderName').textContent = folder.name;
        
        // åˆå§‹åŒ–å­¦ä¹ é˜Ÿåˆ— (æµ…æ‹·è´ï¼Œä¸ºäº†ä¸æ‰“ä¹±åŸå§‹é¡ºåºï¼Œæˆ–è€…ä½ å¯ä»¥åšéšæœºæ´—ç‰Œ)
        studyQueue = [...folder.words];
        if (studyQueue.length === 0) {
            // ç©ºæ–‡ä»¶å¤¹å¤„ç†
            showEmptyCard();
        } else {
            currentCardIndex = 0;
            renderCard();
        }
    }

    function goHome() {
        document.getElementById('view-study').classList.remove('active');
        document.getElementById('view-home').classList.add('active');
        currentFolderId = null;
        renderHome(); // åˆ·æ–°æ•°å­—
    }

    function showEmptyCard() {
        document.getElementById('front-word').textContent = "ç©ºç©ºå¦‚ä¹Ÿ";
        document.getElementById('back-word').textContent = "ç©ºç©ºå¦‚ä¹Ÿ";
        document.getElementById('back-def').textContent = "ç‚¹å‡»å³ä¸Šè§’ã€Œ+å¯¼å…¥ã€æ·»åŠ å•è¯";
        document.getElementById('back-sentence').textContent = "";
    }

    function renderCard() {
        if (studyQueue.length === 0) {
            showEmptyCard();
            return;
        }
        const item = studyQueue[currentCardIndex];
        
        document.getElementById('front-word').textContent = item.word;
        document.getElementById('back-word').textContent = item.word;
        document.getElementById('back-def').textContent = item.definition;
        document.getElementById('back-sentence').textContent = item.sentence;

        isFlipped = false;
        document.getElementById('flashcard').classList.remove('is-flipped');
    }

    function flipCard() {
        if (studyQueue.length === 0) return;
        const card = document.getElementById('flashcard');
        isFlipped = !isFlipped;
        card.classList.toggle('is-flipped', isFlipped);
        if(isFlipped) playAudio();
    }

    function playAudio(e) {
        if(e) e.stopPropagation();
        if (studyQueue.length === 0) return;

        const text = studyQueue[currentCardIndex].word;
        const utterance = new SpeechSynthesisUtterance(text);
        const voices = window.speechSynthesis.getVoices();
        const usVoice = voices.find(v => v.lang === 'en-US');
        if (usVoice) utterance.voice = usVoice;
        utterance.rate = 0.9;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utterance);
    }

    function nextCard(known) {
        if (studyQueue.length === 0) return;

        if (!known) {
            // ä¸è®¤è¯†ï¼ŒæŠŠè¿™ä¸ªè¯åŠ åˆ°é˜Ÿå°¾å†å¤ä¹ ä¸€æ¬¡
            studyQueue.push(studyQueue[currentCardIndex]);
        }
        
        currentCardIndex = (currentCardIndex + 1) % studyQueue.length;
        renderCard();
        
        // ç®€å•åŠ¨æ•ˆï¼š0.3ç§’åè‡ªåŠ¨è¯»æ–°è¯
        setTimeout(() => {
            if(!isFlipped) playAudio(null);
        }, 300);
    }

    // --- å¯¼å…¥é€»è¾‘ ---
    function openImportModal() {
        const folder = appData.find(f => f.id === currentFolderId);
        document.getElementById('importTargetName').textContent = folder.name;
        document.getElementById('modalImport').classList.add('open');
        document.getElementById('jsonInput').value = '';
    }

    function importWords() {
        const input = document.getElementById('jsonInput').value;
        if(!input.trim()) return;

        try {
            const newWords = JSON.parse(input);
            if (!Array.isArray(newWords)) throw new Error("å¿…é¡»æ˜¯æ•°ç»„æ ¼å¼");

            const folder = appData.find(f => f.id === currentFolderId);
            
            // å»é‡æ·»åŠ 
            let added = 0;
            const existingWords = new Set(folder.words.map(w => w.word.toLowerCase()));
            
            newWords.forEach(w => {
                if (w.word && !existingWords.has(w.word.toLowerCase())) {
                    folder.words.push(w);
                    existingWords.add(w.word.toLowerCase());
                    added++;
                }
            });

            saveToLocal();
            alert(`æˆåŠŸå¯¼å…¥ ${added} ä¸ªæ–°å•è¯ï¼`);
            
            // åˆ·æ–°å½“å‰å­¦ä¹ é˜Ÿåˆ—
            studyQueue = [...folder.words];
            currentCardIndex = 0;
            renderCard();
            closeModal('modalImport');

        } catch (e) {
            alert("æ ¼å¼é”™è¯¯ï¼š" + e.message);
        }
    }

    // --- å…¨å±€è®¾ç½® & å¯¼å‡ºé€»è¾‘ ---
    function openGlobalSettings() {
        document.getElementById('modalSettings').classList.add('open');
    }

    function exportData() {
        // åˆ›å»ºä¸€ä¸ª JSON æ–‡ä»¶ä¾›ä¸‹è½½
        const dataStr = JSON.stringify(appData, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `my_vocabulary_backup_${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function clearAllData() {
        if(confirm("âš ï¸ è­¦å‘Šï¼šè¿™å°†åˆ é™¤æ‰€æœ‰æ–‡ä»¶å¤¹å’Œå•è¯ï¼Œä¸”æ— æ³•æ¢å¤ï¼\n\nç¡®å®šè¦æ¸…ç©ºå—ï¼Ÿ")) {
            localStorage.removeItem('myWords');
            location.reload();
        }
    }

    // é€šç”¨å…³é—­å¼¹çª—
    function closeModal(id) {
        document.getElementById(id).classList.remove('open');
    }
</script>

</body>
</html>
