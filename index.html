<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å•è¯å¡ç‰‡ v5.2</title>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f1f5f9;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-sub: #64748b;
            --red: #ef4444;
            --green: #22c55e;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            color: var(--text-main);
        }

        button { border: none; outline: none; cursor: pointer; font-family: inherit; }

        .view { display: none; flex: 1; flex-direction: column; height: 100%; overflow: hidden; }
        .view.active { display: flex; }

        /* é¦–é¡µæ ·å¼ */
        .home-header { padding: 20px; background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .home-title { font-size: 1.4rem; font-weight: 800; }
        .folder-list { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        
        .folder-card { 
            background: #fff; padding: 20px; border-radius: 16px; box-shadow: var(--shadow); 
            display: flex; justify-content: space-between; align-items: center; 
            transition: transform 0.1s; position: relative;
        }
        .folder-card:active { transform: scale(0.98); }
        .folder-info { flex: 1; }
        .folder-info h3 { font-size: 1.1rem; margin-bottom: 4px; }
        .folder-info p { font-size: 0.85rem; color: var(--text-sub); }
        .folder-actions { display: flex; align-items: center; gap: 10px; }
        .more-btn { padding: 8px 12px; font-size: 1.2rem; color: #64748b; background: #f1f5f9; border-radius: 8px; z-index: 5; }
        .folder-arrow { color: #cbd5e1; font-size: 1.2rem; }

        .fab { position: absolute; bottom: 30px; right: 30px; width: 56px; height: 56px; background: var(--primary); color: white; border-radius: 50%; font-size: 2rem; display: flex; justify-content: center; align-items: center; box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.4); z-index: 10; }

        /* å­¦ä¹ é¡µæ ·å¼ */
        .study-header { padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; background: var(--bg); }
        .back-btn { font-size: 1rem; color: var(--text-main); background: none; display: flex; align-items: center; gap: 5px; font-weight: 600; }
        .folder-name-badge { font-size: 0.9rem; font-weight: 600; color: var(--text-sub); }
        .card-area { flex: 1; display: flex; justify-content: center; align-items: center; padding: 20px; perspective: 1000px; }
        
        .card-container { width: 100%; max-width: 340px; height: 500px; position: relative; transform-style: preserve-3d; transition: transform 0.6s cubic-bezier(0.4, 0.2, 0.2, 1); }
        .card-container.is-flipped { transform: rotateY(180deg); }

        .card-face {
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 24px;
            background: var(--card-bg); box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 30px; text-align: center;
        }
        .card-front { z-index: 2; }
        .card-back { transform: rotateY(180deg); justify-content: space-between; padding: 40px 30px; }

        .word { font-size: 2.2rem; font-weight: 800; margin-bottom: 8px; color: var(--text-main); word-break: break-word; line-height: 1.1; }
        .phonetic { font-family: "Lucida Sans Unicode", "Arial Unicode MS", sans-serif; font-size: 1.1rem; color: var(--text-sub); margin-bottom: 20px; font-weight: 400; }
        .definition { font-size: 1.3rem; font-weight: 600; color: var(--text-main); margin-top: 10px; }
        .sentence-box { background: #f8fafc; padding: 16px; border-radius: 12px; width: 100%; text-align: left; font-style: italic; color: #475569; font-size: 0.95rem; }
        .phonetic-btn { background: #eff6ff; color: var(--primary); padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; font-weight: 600; display: flex; align-items: center; gap: 6px; margin-top: 10px; }

        .controls { padding: 20px 30px 40px; display: flex; gap: 20px; width: 100%; max-width: 400px; margin: 0 auto; }
        .ctrl-btn { flex: 1; padding: 16px; border-radius: 16px; font-size: 1rem; font-weight: 700; color: white; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); transition: transform 0.1s; }
        .ctrl-btn:active { transform: scale(0.96); }
        .btn-fail { background: white; color: var(--red); border: 2px solid #fecaca; }
        .btn-pass { background: var(--green); }

        /* å¼¹çª—æ ·å¼ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: flex-end; }
        .modal.open { display: flex; }
        .modal-content { background: white; width: 100%; max-width: 600px; border-radius: 20px 20px 0 0; padding: 24px; animation: slideUp 0.3s ease; max-height: 90vh; overflow-y: auto; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        textarea, input[type="text"] { width: 100%; border: 1px solid #cbd5e1; border-radius: 12px; padding: 14px; font-size: 1rem; margin-bottom: 16px; font-family: inherit; }
        textarea { height: 120px; font-family: monospace; resize: none; }
        .btn-block { width: 100%; padding: 14px; border-radius: 12px; font-weight: 600; margin-bottom: 10px; font-size: 1rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: transparent; border: 1px solid #cbd5e1; color: var(--text-sub); }
        .btn-danger-outline { background: transparent; border: 1px solid #fecaca; color: var(--red); }
        .empty-state { text-align: center; color: #94a3b8; margin-top: 100px; }
    </style>
</head>
<body>

<div id="view-home" class="view active">
    <header class="home-header">
        <div class="home-title">æˆ‘çš„ç”Ÿè¯æœ¬</div>
        <button onclick="openGlobalSettings()" style="font-size:1.5rem; background:none;">âš™ï¸</button>
    </header>
    <div class="folder-list" id="folderList"></div>
    <button class="fab" onclick="openCreateFolder()">+</button>
</div>

<div id="view-study" class="view">
    <header class="study-header">
        <button class="back-btn" onclick="goHome()"><span style="font-size:1.2rem">â€¹</span> è¿”å›åˆ—è¡¨</button>
        <div class="folder-name-badge" id="currentFolderName"></div>
        <button onclick="openImportModal()" style="font-size:1.2rem; background:none; padding:5px;">â• å¯¼å…¥</button>
    </header>

    <div class="card-area">
        <div class="card-container" id="flashcard" onclick="flipCard()">
            <div class="card-face card-front">
                <div class="word" id="front-word">Ready?</div>
                <div class="phonetic" id="front-phonetic"></div>
                <button class="phonetic-btn" onclick="playAudio(event)">ğŸ”Š å‘éŸ³</button>
                <div style="font-size:0.8rem; color:#94a3b8; margin-top:auto">ç‚¹å‡»ç¿»é¢</div>
            </div>
            <div class="card-face card-back">
                <div style="width:100%">
                    <div class="word" id="back-word" style="font-size:1.6rem"></div>
                    <div class="phonetic" id="back-phonetic" style="font-size:1rem; margin-bottom:10px"></div>
                    <div class="definition" id="back-def"></div>
                </div>
                <div class="sentence-box"><div id="back-sentence"></div></div>
                <button class="phonetic-btn" onclick="playAudio(event)">ğŸ”Š</button>
            </div>
        </div>
    </div>

    <div class="controls">
        <button class="ctrl-btn btn-fail" onclick="nextCard(false)">âœ• å¿˜è¯</button>
        <button class="ctrl-btn btn-pass" onclick="nextCard(true)">âœ“ è®°ä½äº†</button>
    </div>
</div>

<div class="modal" id="modalCreateFolder" onclick="if(event.target===this) closeModal('modalCreateFolder')">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">æ–°å»ºæ–‡ä»¶å¤¹</div>
            <button onclick="closeModal('modalCreateFolder')" style="font-size:1.5rem;background:none">Ã—</button>
        </div>
        <input type="text" id="newFolderName" placeholder="ä¾‹å¦‚ï¼šç»æµå­¦äºº / 2024-05 ç”Ÿè¯">
        <button class="btn-block btn-primary" onclick="createFolder()">åˆ›å»º</button>
    </div>
</div>

<div class="modal" id="modalFolderOptions" onclick="if(event.target===this) closeModal('modalFolderOptions')">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">ç®¡ç†: <span id="optFolderName"></span></div>
            <button onclick="closeModal('modalFolderOptions')" style="font-size:1.5rem;background:none">Ã—</button>
        </div>
        <p style="font-size:0.9rem; color:#64748b; margin-bottom:15px">å¯¹è¯¥ç”Ÿè¯æœ¬è¿›è¡Œæ“ä½œï¼š</p>
        <button class="btn-block btn-primary" onclick="exportSingleFolder()">â¬‡ï¸ å¯¼å‡ºæœ¬æ–‡ä»¶å¤¹ (JSON)</button>
        <div style="height:10px"></div>
        <button class="btn-block btn-danger-outline" onclick="deleteSingleFolder()">ğŸ—‘ï¸ åˆ é™¤æœ¬æ–‡ä»¶å¤¹</button>
    </div>
</div>

<div class="modal" id="modalImport" onclick="if(event.target===this) closeModal('modalImport')">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">å¯¼å…¥å•è¯</div>
            <button onclick="closeModal('modalImport')" style="font-size:1.5rem;background:none">Ã—</button>
        </div>
        <p style="font-size:0.9rem; color:#64748b; margin-bottom:10px">ç²˜è´´åŒ…å«éŸ³æ ‡çš„ JSONï¼š</p>
        <textarea id="jsonInput" placeholder='[{"word":"example", "phonetic":"/ex/", "definition":"...", "sentence":"..."}]'></textarea>
        <button class="btn-block btn-primary" onclick="importWords()">ç¡®è®¤å¯¼å…¥</button>
    </div>
</div>

<div class="modal" id="modalSettings" onclick="if(event.target===this) closeModal('modalSettings')">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">è®¾ç½®ä¸å…¨å±€å¤‡ä»½</div>
            <button onclick="closeModal('modalSettings')" style="font-size:1.5rem;background:none">Ã—</button>
        </div>
        <div style="margin-bottom:20px;">
            <p style="font-weight:600; margin-bottom:10px">å…¨å±€æ•°æ®å¤‡ä»½</p>
            <button class="btn-block btn-primary" onclick="exportGlobalData()">â¬‡ï¸ å¯¼å‡ºæ‰€æœ‰æ–‡ä»¶å¤¹ (å®Œæ•´å¤‡ä»½)</button>
        </div>
        <div style="margin-top:20px; border-top:1px solid #eee; padding-top:20px;">
             <p style="font-weight:600; margin-bottom:10px">å±é™©åŒºåŸŸ</p>
             <button class="btn-block btn-outline" style="color:var(--red); border-color:var(--red)" onclick="clearAllData()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ•°æ® (Reset)</button>
        </div>
    </div>
</div>

<script>
    let appData = [];
    let currentFolderId = null;
    let targetFolderId = null;
    let studyQueue = [];
    let currentCardIndex = 0;
    let isFlipped = false;

    window.onload = function() {
        const raw = localStorage.getItem('myWords');
        if (raw) {
            try {
                const parsed = JSON.parse(raw);
                if (Array.isArray(parsed) && parsed.length > 0 && parsed[0].hasOwnProperty('word') && !parsed[0].hasOwnProperty('words')) {
                    appData = [{ id: 'default-' + Date.now(), name: 'é»˜è®¤ç”Ÿè¯æœ¬', words: parsed }];
                    saveToLocal();
                } else if (Array.isArray(parsed)) {
                    appData = parsed;
                } else { initEmpty(); }
            } catch (e) { initEmpty(); }
        } else { initEmpty(); }
        renderHome();
        if(window.speechSynthesis) window.speechSynthesis.getVoices();
    };

    function initEmpty() {
        appData = [{ id: 'folder-1', name: 'æˆ‘çš„ç”Ÿè¯æœ¬', words: [] }];
        saveToLocal();
    }

    function saveToLocal() {
        localStorage.setItem('myWords', JSON.stringify(appData));
        renderHome();
    }

    function renderHome() {
        const list = document.getElementById('folderList');
        list.innerHTML = '';
        if (appData.length === 0) {
            list.innerHTML = `<div class="empty-state">è¿˜æ²¡æœ‰æ–‡ä»¶å¤¹ï¼Œç‚¹å‡»å³ä¸‹è§’ + åˆ›å»º</div>`;
            return;
        }
        appData.forEach(folder => {
            const div = document.createElement('div');
            div.className = 'folder-card';
            div.onclick = () => openFolder(folder.id);
            div.innerHTML = `
                <div class="folder-info"><h3>ğŸ“ ${folder.name}</h3><p>${folder.words.length} ä¸ªå•è¯</p></div>
                <div class="folder-actions">
                    <button class="more-btn" onclick="openFolderOptions('${folder.id}', '${folder.name}', event)">â‹®</button>
                    <div class="folder-arrow">â€º</div>
                </div>
            `;
            list.appendChild(div);
        });
    }

    function openFolderOptions(id, name, event) {
        event.stopPropagation();
        targetFolderId = id;
        document.getElementById('optFolderName').textContent = name;
        document.getElementById('modalFolderOptions').classList.add('open');
    }

    function deleteSingleFolder() {
        if (!targetFolderId) return;
        if (confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶å¤¹å—ï¼Ÿ")) {
            appData = appData.filter(f => f.id !== targetFolderId);
            saveToLocal();
            closeModal('modalFolderOptions');
        }
    }

    function exportSingleFolder() {
        if (!targetFolderId) return;
        const folder = appData.find(f => f.id === targetFolderId);
        if (!folder) return;
        const jsonStr = JSON.stringify(folder.words, null, 2);
        downloadFile(jsonStr, `${folder.name}_words.json`);
        closeModal('modalFolderOptions');
    }

    function downloadFile(content, fileName) {
        const blob = new Blob([content], { type: "application/json" });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = fileName;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }

    function createFolder() {
        const name = document.getElementById('newFolderName').value.trim();
        if (!name) return;
        appData.unshift({ id: 'folder-' + Date.now(), name: name, words: [] });
        saveToLocal();
        closeModal('modalCreateFolder');
    }

    function openFolder(id) {
        currentFolderId = id;
        const folder = appData.find(f => f.id === id);
        if(!folder) return;
        document.getElementById('view-home').classList.remove('active');
        document.getElementById('view-study').classList.add('active');
        document.getElementById('currentFolderName').textContent = folder.name;
        studyQueue = [...folder.words];
        if (studyQueue.length === 0) showEmptyCard();
        else { currentCardIndex = 0; renderCard(); }
    }

    function goHome() {
        document.getElementById('view-study').classList.remove('active');
        document.getElementById('view-home').classList.add('active');
        currentFolderId = null;
        renderHome();
    }

    function showEmptyCard() {
        document.getElementById('front-word').textContent = "ç©ºç©ºå¦‚ä¹Ÿ";
        document.getElementById('front-phonetic').textContent = "";
        document.getElementById('back-word').textContent = "ç©ºç©ºå¦‚ä¹Ÿ";
        document.getElementById('back-phonetic').textContent = "";
        document.getElementById('back-def').textContent = "ç‚¹å‡»å³ä¸Šè§’ã€Œ+å¯¼å…¥ã€æ·»åŠ å•è¯";
        document.getElementById('back-sentence').textContent = "";
    }

    function renderCard() {
        if (studyQueue.length === 0) { showEmptyCard(); return; }
        const item = studyQueue[currentCardIndex];
        document.getElementById('front-word').textContent = item.word;
        document.getElementById('front-phonetic').textContent = item.phonetic || "";
        document.getElementById('back-word').textContent = item.word;
        document.getElementById('back-phonetic').textContent = item.phonetic || "";
        document.getElementById('back-def').textContent = item.definition;
        document.getElementById('back-sentence').textContent = item.sentence;
        isFlipped = false;
        document.getElementById('flashcard').classList.remove('is-flipped');
    }

    function flipCard() {
        if (studyQueue.length === 0) return;
        const card = document.getElementById('flashcard');
        isFlipped = !isFlipped;
        card.classList.toggle('is-flipped', isFlipped);
        if(isFlipped) playAudio();
    }

    // --- ã€ä¿®å¤ã€‘å›æ»šè‡³ v4.1 çš„å‘éŸ³é€»è¾‘ ---
    function playAudio(e) {
        if(e) e.stopPropagation();
        if (studyQueue.length === 0) return;

        window.speechSynthesis.cancel();
        
        const text = studyQueue[currentCardIndex].word;
        const utterance = new SpeechSynthesisUtterance(" " + text); // ä¾ç„¶ä¿ç•™ç©ºæ ¼
        
        const voices = window.speechSynthesis.getVoices();
        const usVoice = voices.find(v => v.lang === 'en-US');
        if (usVoice) utterance.voice = usVoice;
        utterance.rate = 0.9;
        
        // å…³é”®ä¿®å¤ï¼šæ¢å¤ä½¿ç”¨ setTimeout å»¶æ—¶ï¼Œè¿™æ˜¯è§£å†³ä½ æ‰‹æœºåéŸ³çš„å…³é”®
        setTimeout(() => {
            window.speechSynthesis.speak(utterance);
        }, 50);
    }

    function nextCard(known) {
        if (studyQueue.length === 0) return;
        if (!known) studyQueue.push(studyQueue[currentCardIndex]);
        currentCardIndex = (currentCardIndex + 1) % studyQueue.length;
        renderCard();
        // è‡ªåŠ¨æ’­æ”¾æ—¶ç»™äºˆæ›´å……è¶³çš„å»¶æ—¶
        setTimeout(() => { if(!isFlipped) playAudio(null); }, 400); 
    }

    function openImportModal() {
        const folder = appData.find(f => f.id === currentFolderId);
        document.getElementById('modalImport').classList.add('open');
        document.getElementById('jsonInput').value = '';
    }

    function importWords() {
        const input = document.getElementById('jsonInput').value;
        if(!input.trim()) return;
        try {
            const newWords = JSON.parse(input);
            if (!Array.isArray(newWords)) throw new Error("å¿…é¡»æ˜¯æ•°ç»„");
            const folder = appData.find(f => f.id === currentFolderId);
            const existingWords = new Set(folder.words.map(w => w.word.toLowerCase()));
            let added = 0;
            newWords.forEach(w => {
                if (w.word && !existingWords.has(w.word.toLowerCase())) {
                    folder.words.push(w);
                    existingWords.add(w.word.toLowerCase());
                    added++;
                }
            });
            saveToLocal();
            alert(`æˆåŠŸå¯¼å…¥ ${added} ä¸ªæ–°å•è¯ï¼`);
            studyQueue = [...folder.words];
            currentCardIndex = 0;
            renderCard();
            closeModal('modalImport');
        } catch (e) { alert("æ ¼å¼é”™è¯¯ï¼š" + e.message); }
    }

    function openGlobalSettings() { document.getElementById('modalSettings').classList.add('open'); }
    function exportGlobalData() {
        const jsonStr = JSON.stringify(appData, null, 2);
        downloadFile(jsonStr, `my_vocabulary_FULL_BACKUP_${new Date().toISOString().slice(0,10)}.json`);
    }
    function clearAllData() {
        if(confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼")) { localStorage.removeItem('myWords'); location.reload(); }
    }
    function openCreateFolder() {
        document.getElementById('modalCreateFolder').classList.add('open');
        document.getElementById('newFolderName').value = '';
        document.getElementById('newFolderName').focus();
    }
    function closeModal(id) { document.getElementById(id).classList.remove('open'); }
</script>
</body>
</html>
